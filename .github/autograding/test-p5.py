# Part 5: End-to-end solver checks

import jax
jax.config.update('jax_enable_x64', True)

from jax import numpy as jnp
from hw3 import p5

def test_solve():

    # Choose t as an exact multiple of dt to match internal int(t//dt)
    t  = 0.1
    dt = 0.01
    X, V, T = p5.solve(jnp.pi/2, jnp.pi/2, 0.0, 0.0, t, dt)

    n = int(t // dt)
    assert X.shape == (n+1, 2)
    assert V.shape == (n+1, 2)
    assert T.shape == (n+1,)

    # Test solution
    Xref = jnp.array([
        [1.5707963267948966, 1.5707963267948966],
        [1.5707320410806838, 1.5708177553661729],
        [1.5705391839425575, 1.5708820410704687],
        [1.5702177554211276, 1.5709891838219852],
        [1.5697677556743197, 1.571139183287061 ],
        [1.5691891851127377, 1.571332038598183 ],
        [1.568482044589161,  1.571567747953623 ],
        [1.5676463356421557, 1.5718463081027396],
        [1.5666820607937613, 1.5721677137170362],
        [1.565589223901178,  1.5725319566471232],
        [1.5643678305623387, 1.5729390250658342],
    ])
    assert jnp.allclose(X, Xref, rtol=1e-6, atol=1e-6)

    Vref = jnp.array([
        [ 0.0,                  0.0                  ],
        [-0.012857142804957571, 0.0042857141758264805],
        [-0.02571428425626078,  0.008571425491689136 ],
        [-0.03857141758564849,  0.012857119647791331 ],
        [-0.05142852519574887,  0.01714275946488772  ],
        [-0.06428557324602809,  0.021428273445622755 ],
        [-0.07714250624003496,  0.02571354433860207  ],
        [-0.08999924161552542,  0.02999839770853645  ],
        [-0.10285566434003693,  0.03428259051787849  ],
        [-0.11571162151571537,  0.03856579972797007  ],
        [-0.12856691699867212,  0.04284761093083041  ],
    ])
    assert jnp.allclose(V, Vref, rtol=1e-6, atol=1e-6)

    # Time grid spacing
    dT = jnp.diff(T)
    assert jnp.all(dT > 0)
    assert jnp.allclose(dT, float(dt), rtol=1e-6, atol=1e-6)
